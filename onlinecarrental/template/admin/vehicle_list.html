{% extends 'admin/base.html' %}
{% load static %}
{% block content %}
<div class="container mt-4">
    <h2>Vehicle Management</h2>
    
    <!-- Search Bar -->
    <input type="text" id="searchInput" class="form-control mb-3" placeholder="Search vehicles..." onkeyup="searchVehicles()">
    
    <!-- Button to Open the Modal -->
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#vehicleModal" onclick="resetForm()">
        Add Vehicle
    </button>
    
    <!-- Vehicle Table -->
    <table class="table table-bordered mt-3" id="vehicleTable">
        <thead>
            <tr>
                <th>image</th>
                <th>Brand</th>
                <th>Model</th>
                <th>Number Plate</th>
                <th>Price/Day</th>
                <th>Mileage</th>
                <th>Fuel Type</th>
                <th>Transmission</th>
                <th>Availability</th>
                <th>Vehicle Type</th>
                <th>Features</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for vehicle in vehicles %}
            <tr>
                <td><img src="{% if vehicle.image %}{{ vehicle.image.url }}{% else %}https://www.google.com/images/branding/googlelogo/2x/googlelogo_color_272x92dp.png{% endif %}" 
     alt="{{ vehicle.brand }}" 
     style="width: 100px;"></td>
                <td>{{ vehicle.brand }}</td>
                <td>{{ vehicle.model }}</td>
                <td>{{ vehicle.number_plate }}</td>
                <td>{{ vehicle.price_per_day }}</td>
                <td>{{ vehicle.mileage }}</td>
                <td>{{ vehicle.fuel_type }}</td>
                <td>{{ vehicle.transmission_type }}</td>
                <td>{{ vehicle.availability }}</td>
                <td>{{ vehicle.vehicle_type }}</td>
                <td>{{ vehicle.features }}</td>
                <td>
                    <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#vehicleModal" 
                    onclick="editVehicle(
                        '{{ vehicle.id|escapejs }}',
                        '{{ vehicle.brand|escapejs }}',
                        '{{ vehicle.model|escapejs }}',
                        '{{ vehicle.number_plate|escapejs }}',
                        '{{ vehicle.price_per_day|escapejs }}',
                        '{{ vehicle.mileage|escapejs }}',
                        '{{ vehicle.fuel_type|escapejs }}',
                        '{{ vehicle.transmission_type|escapejs }}',
                        '{{ vehicle.availability|escapejs }}',
                        '{{ vehicle.vehicle_type|escapejs }}',
                        '{{ vehicle.features|escapejs }}',
                        '{% if vehicle.image %}{{ vehicle.image.url|escapejs }}{% endif %}'
                    )">
                        Edit
                    </button>
                    <a href="/delete_vehicle/{{ vehicle.id }}/" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this vehicle?');">Delete</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Vehicle Modal -->
<div class="modal fade" id="vehicleModal" tabindex="-1" aria-labelledby="vehicleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="vehicleModalLabel">Add Vehicle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" enctype="multipart/form-data" id="vehicleForm">
                    {% csrf_token %}
                    <input type="hidden" name="vehicle_id" id="vehicle_id">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="brand" class="form-label">Brand</label>
                            <input type="text" class="form-control" id="brand" name="brand" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="model" class="form-label">Model</label>
                            <input type="text" class="form-control" id="model" name="model" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="number_plate" class="form-label">Number Plate</label>
                            <input type="text" class="form-control" id="number_plate" name="number_plate" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="price_per_day" class="form-label">Price per Day</label>
                            <input type="number" class="form-control" id="price_per_day" name="price_per_day" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="mileage" class="form-label">Mileage</label>
                            <input type="number" class="form-control" id="mileage" name="mileage" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="fuel_type" class="form-label">Fuel Type</label>
                            <select class="form-control" id="fuel_type" name="fuel_type">
                                <option value="Petrol">Petrol</option>
                                <option value="Diesel">Diesel</option>
                                <option value="Electric">Electric</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="vehicle_type" class="form-label">Vehicle Type</label>
                            <select class="form-control" id="vehicle_type" name="vehicle_type">
                                <option value="Sedan">Sedan</option>
                                <option value="SUV">SUV</option>
                                <option value="Hatchback">Hatchback</option>
                                <option value="Truck">Truck</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="features">Features</label>
                            <textarea name="features" id="features" class="form-control"></textarea>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="transmission_type" class="form-label">Transmission</label>
                            <select class="form-control" id="transmission_type" name="transmission_type">
                                <option value="Manual">Manual</option>
                                <option value="Automatic">Automatic</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="availability" class="form-label">Availability</label>
                            <select class="form-control" id="availability" name="availability">
                                <option value="Available">Available</option>
                                <option value="Booked">Booked</option>
                                <option value="Maintenance">Maintenance</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="image" class="form-label">Image</label>
                        <input type="file" class="form-control" id="image" name="image">
                        <img id="currentImage" src="" style="max-width: 200px; margin-top: 10px; display: none;" alt="Current Vehicle Image">
                    </div>

                    <button type="submit" class="btn btn-success">Save</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function searchVehicles() {
        let input = document.getElementById("searchInput").value.toLowerCase();
        let rows = document.querySelectorAll("#vehicleTable tbody tr");
        rows.forEach(row => {
            let text = row.innerText.toLowerCase();
            row.style.display = text.includes(input) ? "" : "none";
        });
    }

    function editVehicle(id, brand, model, number_plate, price, mileage, fuel, transmission, availability, vehicleType, features, imageURL) {
        document.getElementById("vehicle_id").value = id;
        document.getElementById("brand").value = brand;
        document.getElementById("model").value = model;
        document.getElementById("number_plate").value = number_plate;
        document.getElementById("price_per_day").value = price;
        document.getElementById("mileage").value = mileage;
        document.getElementById("fuel_type").value = fuel;
        document.getElementById("transmission_type").value = transmission;
        document.getElementById("availability").value = availability;
        document.getElementById("vehicle_type").value = vehicleType;
        document.getElementById("features").value = features;
        document.getElementById("vehicleForm").action = `/update_vehicle/${id}/`;

        // Handle current image display
        const currentImage = document.getElementById("currentImage");
        if (imageURL) {
            currentImage.src = imageURL;
            currentImage.style.display = "block";
        } else {
            currentImage.src = "";
            currentImage.style.display = "none";
        }
    }

    function resetForm() {
        document.getElementById("vehicleForm").reset();
        document.getElementById("vehicle_id").value = "";
        document.getElementById("fuel_type").selectedIndex = 0;
        document.getElementById("transmission_type").selectedIndex = 0;
        document.getElementById("availability").selectedIndex = 0;
        document.getElementById("vehicle_type").selectedIndex = 0;
        document.getElementById("features").value = "";
        document.getElementById("image").value = "";
        document.getElementById("vehicleForm").action = "/add_vehicle/";
        // Reset image preview
        document.getElementById("currentImage").src = "";
        document.getElementById("currentImage").style.display = "none";
    }
</script>
{% endblock %}

